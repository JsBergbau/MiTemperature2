[{"id":"7792f3e3.90fa54","type":"debug","z":"892ece47.eea0d","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1030,"y":1460,"wires":[]},{"id":"95cb1a53.33c6e","type":"http in","z":"892ece47.eea0d","name":"","url":"/MiTemperature2Input","method":"post","upload":false,"swaggerDoc":"","x":180,"y":1620,"wires":[["2039f2f0.1132a6","9c3ed4d1.6fdfa"]]},{"id":"2039f2f0.1132a6","type":"http response","z":"892ece47.eea0d","name":"","statusCode":"","headers":{},"x":510,"y":1680,"wires":[]},{"id":"9c3ed4d1.6fdfa","type":"change","z":"892ece47.eea0d","name":"sensorlist","rules":[{"t":"set","p":"sensors","pt":"msg","to":"{\"info\":{\"info1\":\"MAC Adresses must be in UPPERCASE otherwise sensor won't be found by the script\",\"info2\":\"now all available options are listet. If offset1, offset2, calpoint1 and calpoint2 are given 2Point calibration is used instead of humidityOffset.\",\"info3\":\"Note options are case sensitive\",\"sensorname\":\"Specify an easy readable name\",\"humidityoffset\":-5,\"offset1\":-10,\"offset2\":10,\"calpoint1\":33,\"calpoint2\":75},\"BD:AD:CA:1F:4D:12\":{\"sensorname\":\"Living Room\",\"offset1\":-2,\"offset2\":2,\"calpoint1\":33,\"calpoint2\":75}}","tot":"json"},{"t":"set","p":"processOnlyListedSensors","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":1620,"wires":[["5ea7697d.8ef96"]]},{"id":"5ea7697d.8ef96","type":"function","z":"892ece47.eea0d","name":"Process and calibrate sensors","func":"processOnlyListedSensors = msg.processOnlyListedSensors || false;\n\nfunction calibrateHumidity2Points(humidity, offset1, offset2, calpoint1, calpoint2)\n{\n    p1y=calpoint1\n\tp2y=calpoint2\n\tp1x=p1y - offset1\n\tp2x=p2y - offset2\n\tm = (p1y - p2y) * 1.0 / (p1x - p2x)\n\tb = p2y - m * p2x //would be more efficient to do this calculations only once\n\thumidityCalibrated=m*humidity + b\n\tif (humidityCalibrated > 100 ) //with correct calibration this should not happen\n\t{\n\t    humidityCalibrated = 100\n\t}\n\telse if (humidityCalibrated < 0)\n\t{\n\t\thumidityCalibrated = 0\n\t}\n\thumidityCalibrated=Math.round(humidityCalibrated,0)\n\treturn humidityCalibrated\n}\n\n//\"A4:C1:38:69:E2:7C\"\nmsg.topic = msg.payload.sensor;\n\nif (msg.payload.sensor in msg.sensors )\n{\n    sensor =  msg.payload.sensor;\n    sensordaten = msg.sensors[sensor];\n    msg.payload.sensor = sensordaten.sensorname;\n    msg.topic = msg.payload.sensor;\n    if (\"offset1\" in sensordaten && \"offset2\" in sensordaten && \"calpoint1\" in sensordaten && \"calpoint2\" in sensordaten)\n    {\n        msg.payload.humidity = calibrateHumidity2Points(msg.payload.humidity, sensordaten.offset1, sensordaten.offset2, sensordaten.calpoint1,sensordaten.calpoint2);\n    }\n    else if (\"humidityOffset\" in sensordaten)\n    {\n        msg.payload.humidity = msg.payload.humidity + sensordaten.humidityOffset\n    }\n    \n    return msg;\n}\nelse if (! processOnlyListedSensors)\n{\n    return msg;\n}\n//drop message because only listed sensors should be processed here","outputs":1,"noerr":0,"initialize":"","finalize":"","x":790,"y":1620,"wires":[["7792f3e3.90fa54","bf91ceb1.25764","90123f90.4d9d68","638a88d4.074aa8"]]},{"id":"bf91ceb1.25764","type":"change","z":"892ece47.eea0d","name":"Process for influxdb","rules":[{"t":"set","p":"measurement","pt":"msg","to":"tempMeasurement","tot":"str"},{"t":"set","p":"precision","pt":"msg","to":"s","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"[\t{\t    \"Temperature\" : $.payload.temperature,\t    \"humidity\" : $.payload.humidity,\t    \"voltage\": $.payload.voltage,\t    \"time\" : $floor($.payload.timestamp/25)*25\t},\t{\t    \"Sensorname\": $.topic\t}\t]","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1120,"y":1620,"wires":[["a438ce61.05b658"]]},{"id":"4128ee0d.2701d8","type":"comment","z":"892ece47.eea0d","name":"Node-Red input interface for LYWSD03MMC sensors via Callback","info":"","x":280,"y":1440,"wires":[]},{"id":"a438ce61.05b658","type":"influxdb out","z":"892ece47.eea0d","influxdb":"f1b4eaef.a4fb88","name":"","measurement":"","precision":"","retentionPolicy":"","x":1450,"y":1620,"wires":[]},{"id":"8a07fb58.2a3da8","type":"comment","z":"892ece47.eea0d","name":"Change here for your sensorlist","info":"If you want to output all your sensors, not only from your sensorlist, set \"processOnlyListedSensors\" to \"false\"","x":590,"y":1580,"wires":[]},{"id":"7e5b3940.65cf3","type":"comment","z":"892ece47.eea0d","name":"Change here your measurement name","info":"The time for influx chunked into 25s segments, ideal for an advertisment intervall of 10s in ATC firmware. With storing the data every 25s, almost every timestamp is stored. This leads to RLE compression of the timestamp thus saving a lot of space in influxdb.\nWith an interval of 20 seconds in tests it occured quite often, that timestamp slots were not filled and thus no RLE compression can be used.","x":1170,"y":1580,"wires":[]},{"id":"638a88d4.074aa8","type":"switch","z":"892ece47.eea0d","name":"Filter sensor","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"Living Room","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1090,"y":1820,"wires":[["78bc1bab.99eb6c"]]},{"id":"78bc1bab.99eb6c","type":"debug","z":"892ece47.eea0d","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1410,"y":1820,"wires":[]},{"id":"90123f90.4d9d68","type":"switch","z":"892ece47.eea0d","name":"Filter receiver","property":"req.ip","propertyType":"msg","rules":[{"t":"eq","v":"192.168.178.14","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1100,"y":1760,"wires":[["d5118881.e987d8"]]},{"id":"d5118881.e987d8","type":"debug","z":"892ece47.eea0d","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1410,"y":1760,"wires":[]},{"id":"36855753.1717e8","type":"comment","z":"892ece47.eea0d","name":"Debug / informational part","info":"You can filter here for output of the values of different sensors\n\nAnd you can filter which device sent the input in case you have multiple receivers.","x":1130,"y":1700,"wires":[]},{"id":"6e9028cd.588e6","type":"exec","z":"892ece47.eea0d","command":"/home/pi/MiTemperature2/LYWSD03MMC.py","addpay":true,"append":"","useSpawn":"true","timer":"","oldrc":false,"name":"","x":930,"y":1200,"wires":[["b2f91979.64578"],[],[]]},{"id":"37a90846.8eb728","type":"inject","z":"892ece47.eea0d","name":"Start LYWSD03MMC.py in ATC Mode","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"--atc --watchdogtimer 5 --callback sendToNodeRed.sh --rssi","payloadType":"str","x":230,"y":1140,"wires":[["5c352b22.37b81c"]]},{"id":"b2f91979.64578","type":"debug","z":"892ece47.eea0d","name":"Check if everything is correct running","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1330,"y":1180,"wires":[]},{"id":"a12549ac.15243","type":"comment","z":"892ece47.eea0d","name":"Execute LYWSD03MMC.py directly in Node-RED with Callback mode","info":"Of course you can still run it via normal commandline / cronjob / ...\n","x":290,"y":1080,"wires":[]},{"id":"32097f29.8c395","type":"inject","z":"892ece47.eea0d","name":"Stop Process","props":[{"p":"kill","v":"","vt":"date"},{"p":"reset","v":"","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":150,"y":1200,"wires":[["5c352b22.37b81c","6e9028cd.588e6"]]},{"id":"5c352b22.37b81c","type":"trigger","z":"892ece47.eea0d","name":"Ensure only one instance","op1":"","op2":"0","op1type":"pay","op2type":"str","duration":"0","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":1140,"wires":[["6e9028cd.588e6"]]}]